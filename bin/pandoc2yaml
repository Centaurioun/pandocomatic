#!/usr/bin/env ruby

require 'trollop'
require 'yaml'

require_relative '../lib/pandocomatic/pandoc_metadata.rb'

opts = Trollop::options do
  version "pandoc2yaml 1"
  banner <<-EOB

pandoc2yaml collects the metadata in a pandoc markdown file and exports it to
yaml.

Usage:

    pandoc2yaml [-o output.yaml] input.markdown

Options:
EOB

  opt :output, "optional output file, use STDOUT as default", :type => :string
end

begin
  if ARGV.length != 1 then
    Trollop::die "pandoc2yaml expects one input file as argument"
  end

  input = ARGV.first

  Trollop::die "#{input} does not exist" if not File.exist? input
  Trollop::die "#{input} is not a file" if not File.file? input
  Trollop::die "#{input} is not readable" if not File.readable? input
  
  metadata = YAML.dump Pandocomatic::PandocMetadata.load_file input

  if opts[:output].nil? then
    $stdout << metadata 
  else
    File.open(opts[:output], "w") do |file|
      file << metadata
    end
  end

rescue Exception => e
  warn "Error while collecting metadata: #{e.message}"
end
